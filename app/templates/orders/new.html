{% extends "base.html" %}
{% block title %}New Order - Pizza Management System{% endblock %}
{% block content %}
<h1 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Create New Order</h1>
<div class="row">
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header"><h5>Order Details</h5></div>
            <div class="card-body">
                <div class="mb-3"><label>Customer</label><select class="form-control" id="customer_id" required>
                    <option value="">Select Customer...</option>
                    {% for customer in customers %}<option value="{{ customer.customer_id }}">{{ customer.full_name }}</option>{% endfor %}
                </select></div>
                <div class="mb-3"><label>Tax Rate (%)</label><input type="number" step="0.01" class="form-control" id="tax_rate" value="7.00" required></div>
                <div class="mb-3"><label>Notes</label><textarea class="form-control" id="notes" rows="2"></textarea></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header"><h5>Select Pizzas</h5></div>
            <div class="card-body">
                {% for pizza in pizzas %}
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><strong>{{ pizza.name }}</strong> ({{ pizza.size }}) - ${{ "%.2f"|format(pizza.base_price) }}</div>
                        <div><button class="btn btn-sm btn-success" onclick="addToOrder({{ pizza.pizza_id }}, '{{ pizza.name }}', '{{ pizza.size }}', {{ pizza.base_price }})">Add</button></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header"><h5>Order Summary</h5></div>
            <div class="card-body" id="orderSummary"><p class="text-muted">No items added</p></div>
            <div class="card-footer">
                <div class="d-flex justify-content-between mb-2"><strong>Subtotal:</strong><span id="subtotal">$0.00</span></div>
                <div class="d-flex justify-content-between mb-2"><strong>Tax:</strong><span id="tax">$0.00</span></div>
                <hr>
                <div class="d-flex justify-content-between mb-3"><strong>Total:</strong><strong id="total">$0.00</strong></div>
                <button class="btn btn-primary w-100" onclick="submitOrder()">Place Order</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let orderItems = [];
function addToOrder(id, name, size, price) {
    const existing = orderItems.find(i => i.pizza_id === id);
    if (existing) { existing.quantity++; } else { orderItems.push({pizza_id: id, name, size, unit_price: price, quantity: 1}); }
    updateSummary();
}
function removeItem(id) { orderItems = orderItems.filter(i => i.pizza_id !== id); updateSummary(); }
function updateSummary() {
    if (orderItems.length === 0) { $('#orderSummary').html('<p class="text-muted">No items</p>'); $('#subtotal,#tax,#total').text('$0.00'); return; }
    let html = '<table class="table table-sm">';
    let subtotal = 0;
    orderItems.forEach(item => {
        const itemTotal = item.quantity * item.unit_price;
        subtotal += itemTotal;
        html += `<tr><td>${item.name} (${item.size})</td><td>${item.quantity}x</td><td>$${itemTotal.toFixed(2)}</td><td><button class="btn btn-sm btn-danger" onclick="removeItem(${item.pizza_id})">Ã—</button></td></tr>`;
    });
    html += '</table>';
    $('#orderSummary').html(html);
    const taxRate = parseFloat($('#tax_rate').val()) / 100;
    const taxAmount = subtotal * taxRate;
    const total = subtotal + taxAmount;
    $('#subtotal').text('$' + subtotal.toFixed(2));
    $('#tax').text('$' + taxAmount.toFixed(2));
    $('#total').text('$' + total.toFixed(2));
}
function submitOrder() {
    if (!$('#customer_id').val()) { alert('Select a customer'); return; }
    if (orderItems.length === 0) { alert('Add items'); return; }
    const data = {
        customer_id: $('#customer_id').val(),
        tax_rate: parseFloat($('#tax_rate').val()) / 100,
        notes: $('#notes').val(),
        items: orderItems
    };
    $.ajax({
        url: "{{ url_for('orders.create') }}",
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(r) { alert(r.message); window.location.href = "{{ url_for('orders.index') }}"; },
        error: function() { alert('Error creating order'); }
    });
}
$('#tax_rate').on('input', updateSummary);
</script>
{% endblock %}
