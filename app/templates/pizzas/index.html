{% extends "base.html" %}
{% block title %}Pizzas - Pizza Management System{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-pizza-slice me-2"></i>Pizzas {% if show_archived %}<span class="badge bg-secondary">Archived</span>{% endif %}</h1>
    <div>
        {% if show_archived %}
            <a href="{{ url_for('pizzas.index') }}" class="btn btn-secondary me-2">
                <i class="fas fa-list me-2"></i>Show Active
            </a>
        {% else %}
            <a href="{{ url_for('pizzas.archived') }}" class="btn btn-secondary me-2">
                <i class="fas fa-archive me-2"></i>Show Archived
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPizzaModal">
                <i class="fas fa-plus me-2"></i>Add Pizza
            </button>
        {% endif %}
    </div>
</div>
<!-- Table View (Desktop) -->
<div class="card d-none d-md-block">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr><th>ID</th><th>Name</th><th>Size</th><th>Price</th><th>Category</th><th>Available</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    {% for pizza in pizzas %}
                    <tr>
                        <td>{{ pizza.pizza_id }}</td>
                        <td>{{ pizza.name }}</td>
                        <td>{{ pizza.size }}</td>
                        <td>${{ "%.2f"|format(pizza.base_price) }}</td>
                        <td><span class="badge bg-info">{{ pizza.category }}</span></td>
                        <td>{% if pizza.available %}<i class="fas fa-check text-success"></i>{% else %}<i class="fas fa-times text-danger"></i>{% endif %}</td>
                        <td>
                            {% if show_archived %}
                                <button class="btn btn-sm btn-success" onclick="restorePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')"><i class="fas fa-undo"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="confirmPermanentDeletePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')"><i class="fas fa-trash"></i></button>
                            {% else %}
                                <button class="btn btn-sm btn-warning" onclick="editPizza({{ pizza.pizza_id }})"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeletePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')"><i class="fas fa-archive"></i></button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Card View (Mobile) -->
<div class="d-md-none">
    {% for pizza in pizzas %}
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h5 class="card-title mb-1">{{ pizza.name }}</h5>
                    <span class="badge bg-info">{{ pizza.category }}</span>
                </div>
                <div>
                    {% if show_archived %}
                        <button class="btn btn-sm btn-success me-1" onclick="restorePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmPermanentDeletePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')">
                            <i class="fas fa-trash"></i>
                        </button>
                    {% else %}
                        <button class="btn btn-sm btn-warning me-1" onclick="editPizza({{ pizza.pizza_id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDeletePizza({{ pizza.pizza_id }}, '{{ pizza.name }} ({{ pizza.size }})')">
                            <i class="fas fa-archive"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
            <p class="card-text text-muted mb-2">{{ pizza.description if pizza.description else 'No description' }}</p>
            <div class="row g-2">
                <div class="col-6">
                    <small class="text-muted">Size:</small><br>
                    <strong>{{ pizza.size }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">Price:</small><br>
                    <strong>${{ "%.2f"|format(pizza.base_price) }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">ID:</small><br>
                    <strong>#{{ pizza.pizza_id }}</strong>
                </div>
                <div class="col-6">
                    <small class="text-muted">Available:</small><br>
                    {% if pizza.available %}
                        <i class="fas fa-check text-success"></i> <span class="text-success">Yes</span>
                    {% else %}
                        <i class="fas fa-times text-danger"></i> <span class="text-danger">No</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<!-- Add Pizza Modal -->
<div class="modal fade" id="addPizzaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add New Pizza</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="addPizzaForm">
                <div class="modal-body">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" name="name" required></div>
                    <div class="mb-3"><label>Description</label><textarea class="form-control" name="description" rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Size</label><select class="form-control" name="size" required><option>Small</option><option>Medium</option><option>Large</option></select></div>
                        <div class="col-md-6 mb-3"><label>Price</label><input type="number" step="0.01" class="form-control" name="base_price" required></div>
                    </div>
                    <div class="mb-3"><label>Category</label><select class="form-control" name="category" required><option>Classic</option><option>Specialty</option><option>Vegetarian</option><option>Premium</option></select></div>
                    <div class="mb-3"><input type="checkbox" name="available" value="true" checked> <label>Available</label></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Add Pizza</button></div>
            </form>
        </div>
    </div>
</div>
<!-- Edit Pizza Modal -->
<div class="modal fade" id="editPizzaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Edit Pizza</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <form id="editPizzaForm">
                <input type="hidden" id="edit_pizza_id">
                <div class="modal-body">
                    <div class="mb-3"><label>Name</label><input type="text" class="form-control" id="edit_name" name="name" required></div>
                    <div class="mb-3"><label>Description</label><textarea class="form-control" id="edit_description" name="description" rows="2"></textarea></div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Size</label><select class="form-control" id="edit_size" name="size" required><option>Small</option><option>Medium</option><option>Large</option></select></div>
                        <div class="col-md-6 mb-3"><label>Price</label><input type="number" step="0.01" class="form-control" id="edit_base_price" name="base_price" required></div>
                    </div>
                    <div class="mb-3"><label>Category</label><select class="form-control" id="edit_category" name="category" required><option>Classic</option><option>Specialty</option><option>Vegetarian</option><option>Premium</option></select></div>
                    <div class="mb-3"><input type="checkbox" id="edit_available" name="available" value="true"> <label>Available</label></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-warning">Update Pizza</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePizzaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-archive me-2"></i>Confirm Archive</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to archive this pizza?</p>
                <p class="fw-bold" id="deletePizzaName"></p>
                <p class="text-muted mb-0">This will hide the pizza from the menu while preserving sales data.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmDeletePizzaBtn">Archive Pizza</button>
            </div>
        </div>
    </div>
</div>

<!-- Permanent Delete Confirmation Modal -->
<div class="modal fade" id="permanentDeletePizzaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Permanent Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="fw-bold text-danger">WARNING: This action cannot be undone!</p>
                <p>Are you sure you want to permanently delete this pizza?</p>
                <p class="fw-bold" id="permanentDeletePizzaName"></p>
                <p class="text-muted mb-0">This will remove the pizza from the database completely. If this pizza is referenced in any orders, the deletion will fail.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmPermanentDeletePizzaBtn">Permanently Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
$('#addPizzaForm').on('submit', function(e) {
    e.preventDefault();
    $.post("{{ url_for('pizzas.create') }}", $(this).serialize()).done(function(r) { alert(r.message); location.reload(); });
});
function editPizza(id) {
    $.get("{{ url_for('pizzas.get', pizza_id=0) }}".replace('/0', '/' + id)).done(function(r) {
        if (r.success) {
            $('#edit_pizza_id').val(r.pizza.pizza_id);
            $('#edit_name').val(r.pizza.name);
            $('#edit_description').val(r.pizza.description);
            $('#edit_size').val(r.pizza.size);
            $('#edit_base_price').val(r.pizza.base_price);
            $('#edit_category').val(r.pizza.category);
            $('#edit_available').prop('checked', r.pizza.available);
            $('#editPizzaModal').modal('show');
        }
    });
}
$('#editPizzaForm').on('submit', function(e) {
    e.preventDefault();
    const id = $('#edit_pizza_id').val();
    $.post("{{ url_for('pizzas.update', pizza_id=0) }}".replace('/0', '/' + id), $(this).serialize()).done(function(r) { alert(r.message); location.reload(); });
});
let deletePizzaId = null;

function confirmDeletePizza(id, name) {
    deletePizzaId = id;
    $('#deletePizzaName').text(name);
    $('#deletePizzaModal').modal('show');
}

$('#confirmDeletePizzaBtn').on('click', function() {
    if (deletePizzaId) {
        $.post("{{ url_for('pizzas.delete', pizza_id=0) }}".replace('/0', '/' + deletePizzaId))
            .done(function(r) {
                $('#deletePizzaModal').modal('hide');
                alert(r.message);
                location.reload();
            });
    }
});

// Restore pizza function
function restorePizza(id, name) {
    if (!confirm('Are you sure you want to restore "' + name + '"?')) {
        return;
    }
    $.post("{{ url_for('pizzas.restore', pizza_id=0) }}".replace('/0', '/' + id))
        .done(function(r) {
            alert(r.message);
            location.reload();
        })
        .fail(function() {
            alert('An error occurred while restoring the pizza.');
        });
}

// Permanent delete pizza
let permanentDeletePizzaId = null;

function confirmPermanentDeletePizza(id, name) {
    permanentDeletePizzaId = id;
    $('#permanentDeletePizzaName').text(name);
    $('#permanentDeletePizzaModal').modal('show');
}

$('#confirmPermanentDeletePizzaBtn').on('click', function() {
    if (permanentDeletePizzaId) {
        $.post("{{ url_for('pizzas.permanent_delete', pizza_id=0) }}".replace('/0', '/' + permanentDeletePizzaId))
            .done(function(r) {
                $('#permanentDeletePizzaModal').modal('hide');
                alert(r.message);
                location.reload();
            })
            .fail(function(xhr) {
                $('#permanentDeletePizzaModal').modal('hide');
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.message : 'An error occurred while deleting the pizza.';
                alert(errorMsg);
            });
    }
});
</script>
{% endblock %}
